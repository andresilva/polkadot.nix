name: Update Polkadot Nix Package

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: "0 */4 * * *" # Runs every 4 hours

jobs:
  update-polkadot:
    name: Update Polkadot Nix Package
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Check out repository
        uses: actions/checkout@v4

      # Step 2: Set up Nix
      - name: Set up Nix
        uses: cachix/install-nix-action@v22

      # Step 3: Fetch the latest stable release tag
      - name: Fetch latest stable release
        id: fetch_version
        run: |
          API_URL="https://api.github.com/repos/paritytech/polkadot-sdk/tags"

          # Fetch tags and find the latest stable release matching polkadot-stableYYMM(-x)?
          TAG=$(curl -s $API_URL | jq -r '
            map(select(.name | test("^polkadot-stable[0-9]{4}(-[0-9]+)?$")))
            | sort_by(.name) | reverse | .[0].name'
          )

          if [[ -z "$TAG" ]]; then
            echo "No stable release found. Exiting."
            exit 1
          fi

          VERSION=${TAG#"polkadot-"}
          echo "Latest version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

      # Step 4: Update version in default.nix with placeholder hash
      - name: Update version in default.nix
        run: |
          FILE="default.nix"
          VERSION="${{ env.VERSION }}"

          # Update version, set placeholder hash
          sed -i "s|version = \".*\";|version = \"$VERSION\";|" $FILE
          sed -i "s|hash = \"sha256-[a-zA-Z0-9+/=]*\";|hash = \"sha256-PLACEHOLDER\";|" $FILE

      # Step 5: Build the package to capture the corrected hash
      - name: Build package to find correct hash
        id: get_correct_hash
        run: |
          set -o pipefail

          # Build package to trigger hash mismatch error
          OUTPUT=$(nix build --no-link . 2>&1 | tee build.log || true)

          # Extract the corrected hash from the log
          HASH=$(grep -oP 'got:.*?sha256:\K[a-zA-Z0-9+/=]+' build.log | head -n1)

          if [[ -z "$HASH" ]]; then
            echo "Error: Could not extract corrected hash."
            exit 1
          fi

          echo "Corrected hash: $HASH"
          echo "HASH=$HASH" >> $GITHUB_ENV

      # Step 6: Update default.nix with the corrected hash
      - name: Update Nix file with correct hash
        run: |
          FILE="default.nix"
          HASH="${{ env.HASH }}"

          # Replace placeholder hash with the correct one
          sed -i "s|hash = \"sha256-PLACEHOLDER\";|hash = \"sha256-$HASH\";|" $FILE
          echo "Updated hash in $FILE"

      # Step 7: Commit and push changes
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update Polkadot to latest stable release ${{ env.VERSION }}"
          branch: main
          file_pattern: default.nix
